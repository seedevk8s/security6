<svg viewBox="0 0 1500 1100" xmlns="http://www.w3.org/2000/svg">
  <!-- 배경 -->
  <rect width="1500" height="1100" fill="#f8f9fa"/>
  
  <!-- 제목 -->
  <text x="750" y="30" text-anchor="middle" font-size="22" font-weight="bold" fill="#333">
    Spring Security 8 프로젝트 - 인증 구조 분석
  </text>
  
  <!-- 프로젝트 전체 컨테이너 -->
  <rect x="40" y="50" width="1420" height="1030" fill="none" stroke="#1976d2" stroke-width="3" rx="10"/>
  <text x="70" y="80" font-size="18" font-weight="bold" fill="#1976d2">com.example.security8</text>
  
  <!-- 1. 클라이언트 영역 -->
  <rect x="80" y="100" width="300" height="150" fill="#e3f2fd" stroke="#1565c0" stroke-width="2" rx="5"/>
  <text x="230" y="125" text-anchor="middle" font-size="14" font-weight="bold">Client Browser</text>
  <rect x="100" y="140" width="260" height="90" fill="white" stroke="#90caf9" stroke-width="1" rx="3"/>
  <text x="110" y="160" font-size="11" font-weight="bold">로그인 폼 (login.html)</text>
  <text x="110" y="180" font-size="10">• usernameInput: 사용자명</text>
  <text x="110" y="195" font-size="10">• passwordInput: 비밀번호</text>
  <text x="110" y="210" font-size="10">• POST /aaa (로그인 처리)</text>
  <text x="110" y="225" font-size="10" fill="#4caf50">• 성공: / (메뉴 페이지)</text>
  
  <!-- 2. Controller Layer -->
  <rect x="420" y="100" width="1010" height="150" fill="#e8f5e9" stroke="#43a047" stroke-width="2" rx="5"/>
  <text x="925" y="125" text-anchor="middle" font-size="14" font-weight="bold">Controller Layer</text>
  
  <!-- LoginController -->
  <rect x="440" y="140" width="230" height="90" fill="white" stroke="#66bb6a" stroke-width="1" rx="3"/>
  <text x="555" y="160" text-anchor="middle" font-size="11" font-weight="bold">LoginController</text>
  <text x="450" y="180" font-size="10">@GetMapping("/login")</text>
  <text x="450" y="195" font-size="10">• showLogin(LoginForm)</text>
  <text x="450" y="210" font-size="10">• return "login"</text>
  <text x="450" y="225" font-size="10" fill="#666">※ 로그인 페이지 표시</text>
  
  <!-- MemberController -->
  <rect x="690" y="140" width="230" height="90" fill="white" stroke="#66bb6a" stroke-width="1" rx="3"/>
  <text x="805" y="160" text-anchor="middle" font-size="11" font-weight="bold">MemberController</text>
  <text x="700" y="180" font-size="10">@GetMapping("/")</text>
  <text x="700" y="195" font-size="10">• menu() → "menu"</text>
  <text x="700" y="210" font-size="10">@GetMapping("/todos")</text>
  <text x="700" y="225" font-size="10">• todos() → "todo/list"</text>
  
  <!-- 권한 정보 박스 -->
  <rect x="940" y="140" width="230" height="90" fill="#fff3e0" stroke="#ff9800" stroke-width="1" rx="3"/>
  <text x="1055" y="160" text-anchor="middle" font-size="11" font-weight="bold">URL 권한 설정</text>
  <text x="950" y="180" font-size="10">• /login: permitAll()</text>
  <text x="950" y="195" font-size="10">• /todos/**: ADMIN only</text>
  <text x="950" y="210" font-size="10">• /h2-console: permitAll()</text>
  <text x="950" y="225" font-size="10">• 나머지: authenticated()</text>
  
  <!-- Form 객체 -->
  <rect x="1190" y="140" width="220" height="90" fill="#fce4ec" stroke="#e91e63" stroke-width="1" rx="3"/>
  <text x="1300" y="160" text-anchor="middle" font-size="11" font-weight="bold">LoginForm</text>
  <text x="1200" y="180" font-size="10">@Data (Lombok)</text>
  <text x="1200" y="195" font-size="10">• usernameInput</text>
  <text x="1200" y="210" font-size="10">• passwordInput</text>
  <text x="1200" y="225" font-size="10" fill="#666">※ 폼 데이터 바인딩</text>
  
  <!-- 3. Security Configuration -->
  <rect x="80" y="270" width="1350" height="200" fill="#f3e5f5" stroke="#9c27b0" stroke-width="2" rx="5"/>
  <text x="755" y="295" text-anchor="middle" font-size="14" font-weight="bold">Security Configuration Layer</text>
  
  <!-- SecurityConfig -->
  <rect x="100" y="310" width="400" height="140" fill="white" stroke="#ba68c8" stroke-width="1" rx="3"/>
  <text x="300" y="330" text-anchor="middle" font-size="11" font-weight="bold">SecurityConfig</text>
  <text x="110" y="350" font-size="10" font-family="monospace">@Bean SecurityFilterChain</text>
  <text x="110" y="365" font-size="9">• authorizeHttpRequests: URL별 권한 설정</text>
  <text x="110" y="380" font-size="9">• formLogin: 커스텀 로그인 설정</text>
  <text x="120" y="395" font-size="9">- loginPage: /login</text>
  <text x="120" y="410" font-size="9">- loginProcessingUrl: /aaa</text>
  <text x="120" y="425" font-size="9">- usernameParameter: usernameInput</text>
  <text x="120" y="440" font-size="9">- passwordParameter: passwordInput</text>
  
  <!-- PasswordConfig -->
  <rect x="520" y="310" width="280" height="140" fill="white" stroke="#ba68c8" stroke-width="1" rx="3"/>
  <text x="660" y="330" text-anchor="middle" font-size="11" font-weight="bold">PasswordConfig</text>
  <text x="530" y="350" font-size="10" font-family="monospace">@Bean PasswordEncoder</text>
  <text x="530" y="370" font-size="10">• BCryptPasswordEncoder</text>
  <text x="530" y="390" font-size="10">• 비밀번호 암호화</text>
  <text x="530" y="410" font-size="10">• matches() 검증</text>
  <text x="530" y="430" font-size="10" fill="#666">※ PasswordGenerator로</text>
  <text x="540" y="445" font-size="10" fill="#666">  미리 암호화된 값 생성</text>
  
  <!-- Spring Security Filter Chain -->
  <rect x="820" y="310" width="590" height="140" fill="white" stroke="#ba68c8" stroke-width="1" rx="3"/>
  <text x="1115" y="330" text-anchor="middle" font-size="11" font-weight="bold">Spring Security Filter Chain 동작</text>
  <text x="830" y="350" font-size="10">1. DelegatingFilterProxy → FilterChainProxy</text>
  <text x="830" y="365" font-size="10">2. UsernamePasswordAuthenticationFilter 실행</text>
  <text x="830" y="380" font-size="10">3. Authentication 객체 생성 (username, password)</text>
  <text x="830" y="395" font-size="10">4. AuthenticationManager → Provider로 위임</text>
  <text x="830" y="410" font-size="10">5. LoginUserDetailsServiceImpl.loadUserByUsername() 호출</text>
  <text x="830" y="425" font-size="10">6. 비밀번호 검증 (BCrypt)</text>
  <text x="830" y="440" font-size="10">7. SecurityContext에 Authentication 저장</text>
  
  <!-- 4. Service Layer -->
  <rect x="80" y="490" width="650" height="180" fill="#e1f5fe" stroke="#03a9f4" stroke-width="2" rx="5"/>
  <text x="405" y="515" text-anchor="middle" font-size="14" font-weight="bold">Service Layer (UserDetailsService)</text>
  
  <!-- LoginUserDetailsServiceImpl -->
  <rect x="100" y="530" width="610" height="120" fill="white" stroke="#4fc3f7" stroke-width="1" rx="3"/>
  <text x="405" y="550" text-anchor="middle" font-size="11" font-weight="bold">LoginUserDetailsServiceImpl implements UserDetailsService</text>
  <text x="110" y="570" font-size="10">@Service | @RequiredArgsConstructor</text>
  <text x="110" y="590" font-size="10" font-weight="bold">loadUserByUsername(String username):</text>
  <text x="120" y="605" font-size="9">1. authenticationMapper.selectByUsername(username) → DB 조회</text>
  <text x="120" y="620" font-size="9">2. Authentication 엔티티 → LoginUser(UserDetails) 변환</text>
  <text x="120" y="635" font-size="9">3. 권한 처리: ADMIN은 [ADMIN, USER] 권한, USER는 [USER] 권한</text>
  <text x="400" y="605" font-size="9">4. LoginUser 객체 생성:</text>
  <text x="410" y="620" font-size="9">- username, password (encoded)</text>
  <text x="410" y="635" font-size="9">- authorities, displayname</text>
  
  <!-- 5. Entity Layer -->
  <rect x="750" y="490" width="680" height="180" fill="#fff8e1" stroke="#ff8f00" stroke-width="2" rx="5"/>
  <text x="1090" y="515" text-anchor="middle" font-size="14" font-weight="bold">Entity Layer</text>
  
  <!-- Authentication Entity -->
  <rect x="770" y="530" width="200" height="120" fill="white" stroke="#ffb74d" stroke-width="1" rx="3"/>
  <text x="870" y="550" text-anchor="middle" font-size="11" font-weight="bold">Authentication</text>
  <text x="780" y="570" font-size="10">@Data (DB 매핑)</text>
  <text x="780" y="585" font-size="9">• username: 사용자명</text>
  <text x="780" y="600" font-size="9">• password: 암호화된 PW</text>
  <text x="780" y="615" font-size="9">• authority: Role(ENUM)</text>
  <text x="780" y="630" font-size="9">• displayname: 표시명</text>
  <text x="780" y="645" font-size="8" fill="#666">※ DB authentications 테이블</text>
  
  <!-- LoginUser Entity -->
  <rect x="990" y="530" width="210" height="120" fill="white" stroke="#ffb74d" stroke-width="1" rx="3"/>
  <text x="1095" y="550" text-anchor="middle" font-size="11" font-weight="bold">LoginUser extends User</text>
  <text x="1000" y="570" font-size="10">(UserDetails 구현)</text>
  <text x="1000" y="585" font-size="9">• username (상속)</text>
  <text x="1000" y="600" font-size="9">• password (상속)</text>
  <text x="1000" y="615" font-size="9">• authorities (상속)</text>
  <text x="1000" y="630" font-size="9">• displayname (추가)</text>
  <text x="1000" y="645" font-size="8" fill="#666">※ Security Context 저장용</text>
  
  <!-- Role Enum -->
  <rect x="1220" y="530" width="190" height="120" fill="white" stroke="#ffb74d" stroke-width="1" rx="3"/>
  <text x="1315" y="550" text-anchor="middle" font-size="11" font-weight="bold">Role (Enum)</text>
  <text x="1230" y="570" font-size="10">권한 종류:</text>
  <text x="1230" y="590" font-size="10">• ADMIN</text>
  <text x="1230" y="605" font-size="10">• USER</text>
  <text x="1230" y="625" font-size="9" fill="#4caf50">※ ADMIN은 USER</text>
  <text x="1240" y="640" font-size="9" fill="#4caf50">  권한도 포함</text>
  
  <!-- 6. Repository Layer -->
  <rect x="80" y="690" width="650" height="140" fill="#ffebee" stroke="#ef5350" stroke-width="2" rx="5"/>
  <text x="405" y="715" text-anchor="middle" font-size="14" font-weight="bold">Repository Layer (MyBatis)</text>
  
  <!-- AuthenticationMapper -->
  <rect x="100" y="730" width="610" height="80" fill="white" stroke="#ef9a9a" stroke-width="1" rx="3"/>
  <text x="405" y="750" text-anchor="middle" font-size="11" font-weight="bold">AuthenticationMapper (@Mapper)</text>
  <text x="110" y="770" font-size="10">@Select("SELECT username, password, authority, displayname</text>
  <text x="110" y="785" font-size="10">        FROM authentications WHERE username = #{username}")</text>
  <text x="110" y="800" font-size="10">Authentication selectByUsername(String username);</text>
  
  <!-- 7. Database -->
  <rect x="750" y="690" width="680" height="140" fill="#e0e0e0" stroke="#616161" stroke-width="2" rx="5"/>
  <text x="1090" y="715" text-anchor="middle" font-size="14" font-weight="bold">Database (H2)</text>
  
  <rect x="770" y="730" width="640" height="80" fill="white" stroke="#9e9e9e" stroke-width="1" rx="3"/>
  <text x="1090" y="750" text-anchor="middle" font-size="11" font-weight="bold">authentications 테이블</text>
  <text x="780" y="770" font-size="10" font-family="monospace">| username | password (BCrypt) | authority | displayname |</text>
  <text x="780" y="785" font-size="10" font-family="monospace">|----------|-------------------|-----------|-------------|</text>
  <text x="780" y="800" font-size="10" font-family="monospace">| admin    | $2a$10$xxx...     | ADMIN     | 관리자      |</text>
  
  <!-- 8. 인증 흐름 -->
  <rect x="80" y="850" width="1350" height="210" fill="#fafafa" stroke="#9e9e9e" stroke-width="2" rx="5"/>
  <text x="755" y="875" text-anchor="middle" font-size="14" font-weight="bold">인증 처리 흐름</text>
  
  <!-- 흐름도 -->
  <g>
    <!-- 단계별 박스들 -->
    <rect x="100" y="890" width="140" height="60" fill="#e3f2fd" stroke="#1976d2" stroke-width="1" rx="3"/>
    <text x="170" y="910" text-anchor="middle" font-size="10" font-weight="bold">1. 로그인 요청</text>
    <text x="170" y="925" text-anchor="middle" font-size="9">POST /aaa</text>
    <text x="170" y="940" text-anchor="middle" font-size="9">ID/PW 전송</text>
    
    <rect x="260" y="890" width="140" height="60" fill="#f3e5f5" stroke="#9c27b0" stroke-width="1" rx="3"/>
    <text x="330" y="910" text-anchor="middle" font-size="10" font-weight="bold">2. Filter Chain</text>
    <text x="330" y="925" text-anchor="middle" font-size="9">Username</text>
    <text x="330" y="940" text-anchor="middle" font-size="9">PasswordFilter</text>
    
    <rect x="420" y="890" width="140" height="60" fill="#e1f5fe" stroke="#03a9f4" stroke-width="1" rx="3"/>
    <text x="490" y="910" text-anchor="middle" font-size="10" font-weight="bold">3. UserDetails</text>
    <text x="490" y="925" text-anchor="middle" font-size="9">Service</text>
    <text x="490" y="940" text-anchor="middle" font-size="9">loadUser()</text>
    
    <rect x="580" y="890" width="140" height="60" fill="#ffebee" stroke="#ef5350" stroke-width="1" rx="3"/>
    <text x="650" y="910" text-anchor="middle" font-size="10" font-weight="bold">4. DB 조회</text>
    <text x="650" y="925" text-anchor="middle" font-size="9">MyBatis</text>
    <text x="650" y="940" text-anchor="middle" font-size="9">Mapper</text>
    
    <rect x="740" y="890" width="140" height="60" fill="#fff8e1" stroke="#ff8f00" stroke-width="1" rx="3"/>
    <text x="810" y="910" text-anchor="middle" font-size="10" font-weight="bold">5. LoginUser</text>
    <text x="810" y="925" text-anchor="middle" font-size="9">생성</text>
    <text x="810" y="940" text-anchor="middle" font-size="9">권한 설정</text>
    
    <rect x="900" y="890" width="140" height="60" fill="#f3e5f5" stroke="#9c27b0" stroke-width="1" rx="3"/>
    <text x="970" y="910" text-anchor="middle" font-size="10" font-weight="bold">6. 비밀번호</text>
    <text x="970" y="925" text-anchor="middle" font-size="9">BCrypt</text>
    <text x="970" y="940" text-anchor="middle" font-size="9">검증</text>
    
    <rect x="1060" y="890" width="140" height="60" fill="#e8f5e9" stroke="#4caf50" stroke-width="1" rx="3"/>
    <text x="1130" y="910" text-anchor="middle" font-size="10" font-weight="bold">7. Security</text>
    <text x="1130" y="925" text-anchor="middle" font-size="9">Context</text>
    <text x="1130" y="940" text-anchor="middle" font-size="9">저장</text>
    
    <rect x="1220" y="890" width="140" height="60" fill="#c8e6c9" stroke="#388e3c" stroke-width="1" rx="3"/>
    <text x="1290" y="910" text-anchor="middle" font-size="10" font-weight="bold">8. 성공</text>
    <text x="1290" y="925" text-anchor="middle" font-size="9">JSESSIONID</text>
    <text x="1290" y="940" text-anchor="middle" font-size="9">/ 리다이렉트</text>
  </g>
  
  <!-- 흐름 화살표 -->
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#666"/>
    </marker>
  </defs>
  
  <line x1="240" y1="920" x2="260" y2="920" stroke="#666" stroke-width="2" marker-end="url(#arrow)"/>
  <line x1="400" y1="920" x2="420" y2="920" stroke="#666" stroke-width="2" marker-end="url(#arrow)"/>
  <line x1="560" y1="920" x2="580" y2="920" stroke="#666" stroke-width="2" marker-end="url(#arrow)"/>
  <line x1="720" y1="920" x2="740" y2="920" stroke="#666" stroke-width="2" marker-end="url(#arrow)"/>
  <line x1="880" y1="920" x2="900" y2="920" stroke="#666" stroke-width="2" marker-end="url(#arrow)"/>
  <line x1="1040" y1="920" x2="1060" y2="920" stroke="#666" stroke-width="2" marker-end="url(#arrow)"/>
  <line x1="1200" y1="920" x2="1220" y2="920" stroke="#666" stroke-width="2" marker-end="url(#arrow)"/>
  
  <!-- 실패 경로 -->
  <line x1="970" y1="950" x2="970" y2="980" stroke="#f44336" stroke-width="2" marker-end="url(#arrow)"/>
  <rect x="900" y="980" width="140" height="40" fill="#ffcdd2" stroke="#f44336" stroke-width="1" rx="3"/>
  <text x="970" y="995" text-anchor="middle" font-size="9">인증 실패</text>
  <text x="970" y="1010" text-anchor="middle" font-size="9">/login?error</text>
  
  <!-- 주요 설정 정보 -->
  <rect x="100" y="1030" width="1310" height="30" fill="#e8eaf6" stroke="#5e35b1" stroke-width="1" rx="3"/>
  <text x="110" y="1048" font-size="10" font-weight="bold">주요 설정:</text>
  <text x="200" y="1048" font-size="9">Spring Boot | Spring Security | MyBatis | H2 Database | BCrypt | Lombok</text>
  <text x="700" y="1048" font-size="9">| @MapperScan: com.example.security8.repository</text>
  <text x="1050" y="1048" font-size="9">| CSRF: disabled | H2 Console: enabled</text>
</svg>